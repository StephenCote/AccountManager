<!doctype html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">

        <title>Account Manager Service - Console</title>
		<link rel="shortcut icon" href="/AccountManagerService/favicon.ico">
   		<link rel="stylesheet" href="/AccountManagerService/Style/uwm.css" type="text/css" title = "uwm" />
   		<link rel="stylesheet" href="/AccountManagerService/Style/rocket.css" type="text/css" />

		<script type = "text/javascript">
   			var g_application_path = "/AccountManagerService/";
   			</script>
        <script type = "text/javascript" src = "/AccountManagerService/Scripts/bootstrap.jsp"></script>
   		<script type = "text/javascript">
			irocket.setCommunityMode(false);
			var ctl;
			uwm.addPageLoadHandler(function(){

				ctl = Hemi.newObject("Console","1.0",true,true,{
					object_create : function(){
						var _s = this.getProperties(), _o = this.getObjects();
						_s.iconView = 1;
						_s.maximize = 1;
						_o.history = [];
						_s.historyIndex = 0;
						_o.use = [];
						_o.useMap = {};
						Hemi.event.addScopeBuffer(this);
						this.scopeHandler("keydown",0,0,1);
						this.scopeHandler("session_refresh",0,0,1);
						this.scopeHandler("window_resize",0,0,1);
						Hemi.event.addEventListener(window,"resize",this._prehandle_window_resize);
						Hemi.message.service.subscribe(this, "onsessionrefresh", "_prehandle_session_refresh");
						Hemi.message.service.subscribe(this, "onbuffercommitted", "handle_buffer_commit", this.getList());
						document.getElementById("commandLine").onkeydown = this._prehandle_keydown;
						this.getComponentByRID("typelist").setLoadHandler(this.scopeHandler("configList",0,1,1));
						this.focus();
					},
					
					object_destroy : function(){
						Hemi.message.service.unsubscribe(this, "onsessionrefresh", "handle_session_refresh");
						Hemi.message.service.unsubscribe(this, "onbuffercommitted", "handle_buffer_commit", this.getList());
						Hemi.event.removeEventListener(window,"resize",this._prehandle_window_resize);
					},
					_handle_window_resize : function(){
						this.resizeFrame();
					},
					resizeFrame : function(w, h){
						if(!h && this.getProperties().maximize){
							/// Drop the list size down temporarily
							this.getList().getContainer().style.height = "50px";
							h = (document.getElementById("contentContainer").parentNode.clientHeight - document.getElementById("contentContainer").offsetTop - document.getElementById("commandContainer").offsetHeight) + "px";
							//alert(h + "/" + (document.body.clientHeight - document.getElementById("contentContainer").offsetTop) );
						}
						if(w) document.getElementById("typelist").style.width = w;;
						if(h){
							
							document.getElementById("typelist").style.height = h;
						}
						this.getList().getContainer().style.height = document.getElementById("typelist").clientHeight + "px";
						
					},
					configList : function(s, v){
						this.addLine("Account Manager Service 5.6","_avoid");
						this.addLine("Simple Shell 1.0","_avoid");
						this.refreshDisplay();
						var oL = this.getList();
						oL.setAutoScroll(1);
						var oC = this;
						oL.setResultHandler(function(s,v){
							oC.getList().deselectAllItems();
							if(v && v.data){
								oC.viewObject(v.data);
							}
							//window.dbg = v;
						});
						setTimeout("Hemi.registry.service.getObject('" + this.getObjectId() + "').resizeFrame()",50);

						/// oL.setAutoSelect(1);
					},
					viewObject : function(o){
						var oW;
						if(o.nameType == "DATA"){
							if(o.mimeType.match(/video/gi) || o.mimeType.match(/^image/gi)){
								var bVid = o.mimeType.match(/^video\//gi);
								var sUrl = location.protocol + "//" + location.hostname + (location.port ? ":" + location.port : "") + g_application_path + "media/" + AM6Client.dotPath(AM6Client.currentOrganization) + "/Data" +  o.groupPath + "/" + o.name
								uwm.openPopInImage(sUrl, o.mimeType, bVid, 1);
							}
							else if(o.mimeType.match(/^text/gi) || o.mimeType.match(/xml/gi) || o.mimeType.match(/javascript/gi)){
								var oProps = {openerId:this.getObjectId(),picker:0,viewType:o,autoDisplay:1};
								oW = Hemi.app.createWindow(o.name, uwm.getApiTypeView("DATA") + "/Forms/Data.xml", "View-" + o.id, 0, 0, oProps);

							}
						}
						else if(o.nameType == "GROUP"){
							this.processCommand("cd \"" + o.path + "\"");
							this.processCommand("ls", 1);
						}
						else if(o.nameType == "USER" || o.nameType == "PERSON"){
							if(!o.populated) o = AM6Client.get(o.nameType, o.objectId);
							var oProps = {openerId:this.getObjectId(),picker:0,viewType:o,autoDisplay:1,listType:(o.nameType == "USER" ? "User" : "Person")};
							oW = Hemi.app.createWindow(o.name, uwm.getApiTypeView(o.nameType) + "/Forms/Profile.xml", "View-" + o.id, 0, 0, oProps);
		
						}
					    if (oW) {
					    	oW.resizeTo(475, 400);
					    	Hemi.app.getWindowManager().CenterWindow(oW);
					    	oW.setHideOnClose(0);
					    	oW.setCanMinimize(0);
					    	oW.setCanMaximize(0);
					    	oW.setCanResize(0);
					    }
					},
					addLine : function(s, v){
						var oL = this.getList();
						oL.addItem(s, (v ? v : "_avoid"));
						
					},
					handle_buffer_commit : function(s, v){
						//var oL = this.getList();
						//oL.getContainer().scrollTop = oL.getContainer().scrollHeight;
					},
					getList : function(){
						return this.getComponentByRID("typelist").GetWideSelect();
					},
					getComponentByRID : function(n){
						var o = Hemi.app.space.service.getPrimarySpace().getSpaceObjectByName(n);
						if(!o || !o.object) return 0;
						return o.object.getApplicationComponent();
					},
					peek : function(c, s){
						var _o = this.getObjects(), a = [],p,r,sP;
						if(c.match(/^(ls|cd)$/)){
							sP = s.substring(0,s.lastIndexOf("/"));
							this.processCommand("ls -hide " + sP, 1);
							s = s.substring(s.lastIndexOf("/") + 1, s.length);
						}
						p = new RegExp("^" + s);
						a = _o.currentGroupList;
						if(!c.match(/^(ls|cd)$/)) a = a.concat(_o.currentDataList);
						for(i = 0; i < a.length; i++){
							if(a[i].name.match(p)){
								r = a[i].name;
								break;
							}
						}
						if(r && sP) r = sP + "/" + r;
						return r;
					},
					_handle_keydown : function(e){
						e = Hemi.event.getEvent(e);
						var oS = Hemi.event.getEventSource(e), _s = this.getProperties(); _o = this.getObjects();
						if(!oS || !oS.nodeName || !oS.nodeName.match(/^(input|textarea|select)/gi)) return;
						switch(e.keyCode){
							/// TAB
							case 9:
								var aC = this.parseCommand(document.getElementById("commandLine").value.trim());
								if(this.peekCommands.includes(aC[0])){
									Hemi.event.cancelEvent(e);
									var sPeek = this.peek(aC[0], aC[aC.length-1]);
									if(sPeek){
										var sCmd = document.getElementById("commandLine").value;
										sCmd = sCmd.substring(0,sCmd.lastIndexOf(" ") + 1) + sPeek;
										document.getElementById("commandLine").value = sCmd;
									}
									return false;
								}
								break;
							/// ESC
							case 27:
								document.getElementById("commandLine").value = "";
								break;
							/// Enter
							case 13:
								var cmdL = document.getElementById("commandLine").value.trim()
								var cmd = document.getElementById("prompt").innerText + " " + cmdL;
								this.processCommand(cmdL);
								document.getElementById("commandLine").value = "";
								break;
							/// Up arrow
							case 38:
								if(_s.historyIndex > 0){
									document.getElementById("commandLine").value = _o.history[_s.historyIndex - 1];
									_s.historyIndex--;
								}
								Hemi.event.cancelEvent(e);
								return false;
								break;
							/// Down arrow
							case 40:
								if(_s.historyIndex < _o.history.length){
									_s.historyIndex++;
									document.getElementById("commandLine").value = _o.history[_s.historyIndex - 1];

								}
								Hemi.event.cancelEvent(e);
								return false;
								break;
							default:
								// Hemi.log(e.keyCode);
								break;
						}
						
					},
					parseCommand : function(s){
						var aS;
						if(!s || (aS = s.match(/[\(\)\$@\w\.\-\~\/]+|"[^"]+"/g)) == null) return [];
						return aS;
					},
					isCommand : function(s){
						var aS = this.parseCommand(s);
						return (this.commands[aS[0]] ? 1 : 0);
					},
					useCommand : function(aS, ix){
						var _o = this.getObjects(),o,ues = /^\$(\d+)\./,sC;
						if(!(o = _o.use[ix])){
							this.addLine("Unknown use index '" + ix + "'");
							return;
						}
						if(aS[0].match(ues)){
							sC = aS[0].replace(ues,"");
							/// Method
							if(sC.match(/\(/)){
								if(sC.match(/^view/)){
									this.viewObject(o);
								}
							}
							else{
								this.addLine(o[sC]);	
							}
						}
						else{
							
							for(var i in o){
								if(o[i]) this.addLine("(" + (typeof o[i]) + ") " +  i + " = " + o[i]);
							}
						}
						
						
					},
					processCommand : function(s, bHide){
						var aS = this.parseCommand(s), bAuth = (this.getObjects().user ? 1 : 0), ue = /^\$(\d+)/, m;
						
						if(!aS.length){
							return;
						}
						for(var a = 1; a < aS.length; a++){
							aS[a] = aS[a].replace(/"/gi,"");
						}
						if(!bHide && !this.privateCommands.includes(aS[0])){
							var aH = this.getObjects().history;
							if(!aH.length || aH[aH.length-1] != s){
								aH.push(s);
								this.getProperties().historyIndex = aH.length;
								this.addLine(document.getElementById("prompt").innerText + " " + s);
								this.updateStorage();
							}
						}
						if(!bAuth && !this.anonymousCommands.includes(aS[0])){
							this.addLine("Not authenticated");
							return;
						}
						if(!this.commands[aS[0]] || this.commands[aS[0]] == null){
							if( (m = s.match(ue)) && m.length >= 2 ){
								this.useCommand(aS, parseInt(m[1])-1);
							}
							else{
								this.addLine("Unknown command: " + aS[0]);
							}
							return;
						}
						this.commands[aS[0]].apply(this,aS.slice(1));
						
					
					},
					_handle_session_refresh : function(s,v){
						if(!v || v == null){
							this.processCommand("clearHistory", 1);
							this.processCommand("clear", 1);
						}
						this.refreshDisplay();
					},
					refreshDisplay : function(){
						
						var oU = uwm.getUser(), _o = this.getObjects(), _s = this.getProperties(), sP = "Anonymous:$", sPa = "/";
						_o.user = (oU && oU != null ? oU : null);
						if(_o.user != null){
							sP = oU.name + ":$";
							sPa = "/Home/" + oU.name;
							_s.currentPath = sPa;
							this.loadStorage();
							/// this.processCommand("ls -hide", 1);
							this.processCommand("cd \"" + _s.currentPath + "\"", 1);
						}
						else{
							_s.currentPath = "/";
						}
						
						Hemi.xml.setInnerXHTML(document.getElementById("prompt"), sP);
						
					},
					loadStorage : function(){
						var _o = this.getObjects();
						if(!Hemi.storage.testStorageSupported() || !_o.user) return;
						var hS = Hemi.storage.getStorageProvider();
						var sH = hS.getItem("history-" + _o.user.objectId);
						var sP = hS.getItem("currentPath-" + _o.user.objectId);
						if(sH){
							this.getObjects().history = JSON.parse(sH);
							this.getProperties().historyIndex = this.getObjects().history.length;
						}
						if(sP){
							this.getProperties().currentPath = sP;
						}
					},
					updateStorage : function(){
						var _o = this.getObjects();
						if(!Hemi.storage.testStorageSupported() || !_o.user) return;
						var hS = Hemi.storage.getStorageProvider();
						hS.setItem("history-" + _o.user.objectId, JSON.stringify(this.getObjects().history));
						hS.setItem("currentPath-" + _o.user.objectId, this.getProperties().currentPath);
					},
					focus : function(){
						document.getElementById("commandLine").focus();
					},
					commands : {
						
						cd : function(s){
							var _s = this.getProperties(), _o = this.getObjects();
							if(!s || s.length == 0){
								this.addLine("Invalid argument");
								return;
							}
							s = s.replace(/^\.\//,"");
							if(!s.match(/^[~\/]/)) s = _s.currentPath + "/" + s;
							if(s.match(/\.\./)){
								//if(!s.match(/\/$/)) s = s;	
								s = s.replace(/\/[\w\s]+\/\.\./,"");
							}
							if(s.length > 1) s = s.replace(/\/$/,"");
							var oG = AM6Client.find("GROUP","UNKNOWN",s);
							if(!oG || oG == null){
								this.addLine("Invalid path: " + s);
							}
							else{
								_s.currentPath = oG.path;
								_o.currentGroup = oG;
								this.processCommand("ls -hide", 1);
							}
							
						},
						login : function(){
							if(arguments.length < 2){
								this.addLine("Syntax: login [/Organization] username password");
								return;
							}
							var sOrg = "/Public";
							var i = 0;
							if(arguments.length > 2){
								i = 1;
								sOrg = arguments[0];
							}
							var oC = this;
							AM6Client.loginWithPassword(sOrg, arguments[i], arguments[i+1], function(s, v){
								var oU;
								if(v && v.json){
									AM6Client.clearCache(0,1);
									oU = window.uwm.getUser();
									if(uwm.altFlushSession) uwm.altFlushSession();
									oC.addLine("Welcome!");
									Hemi.message.service.publish("onsessionrefresh", oU);
								}
								
							});
						},
						logout : function(){
							// this.processCommand("clearHistory", 1);
							// this.processCommand("clear", 1);
							var b = uwm.logout();
							if(b) this.addLine("Good bye!");
							delete this.getObjects().currentGroup;
						},
						pwd : function(){
							this.addLine(this.getProperties().currentPath);
							
						},
						help : function(){
							for(var i in this.commands){
								this.addLine(i);
							}
						},
						clearUse : function(){
							this.getObjects().use.length = 0;
							this.getObjects().useMap = {};
						},
						clear : function(){
							this.getList().clearItems();
						},
						clearHistory : function(bClearStorage){
							this.getObjects().history.length = 0;
							this.getProperties().historyIndex = 0;
							if(bClearStorage) this.updateStorage();
							this.addLine("Cleared console history","_avoid");
						},
						history : function(){
							var aH = this.getObjects().history;
							for(var i = 0; i < aH.length; i++) this.addLine(aH[i]);
						},
						use : function(sOpt){
							
							if(!sOpt){
								this.addLine("Syntax: use pattern");
								return;
							}
							var _o = this.getObjects(), a, o, ix;
							a = _o.currentDataList.concat(_o.currentGroupList);
							ix = _o.use.length;
							for(var i = 0; i < a.length; i++){
								if(a[i].name == sOpt){
									o = a[i];
									break;
								}
							}
							if(o){
								if(typeof _o.useMap[o.objectId] != "undefined"){
									this.addLine("Alreading using " + o.objectId);
								}
								else{
									_o.use[ix] = o;
									_o.useMap[o.objectId] = ix;
									this.addLine("Using " + o.name + " (" + o.objectId + ") as $" + (ix + 1));
								}
							}
							else{
								this.addLine("Object not found");
							}
						},
						ls : function(bOpt){
							var sP = this.getProperties().currentPath, _o = this.getObjects(), bNoDisplay = (bOpt == "-hide");
							for(var i = 0; i < arguments.length; i++){
								if(!arguments[i].match(/^-/)){
									sP = arguments[i];
									break;
								}
							}
							if(!sP.match(/^[\.~\/]/)) sP = this.getProperties().currentPath + "/" + sP;
							var oG = AM6Client.find("GROUP","UNKNOWN", sP);
							if(!oG || oG == null){
								this.addLine("Unable to read path: " + sP);
								return;
							}
							var aL = AM6Client.list("GROUP", oG.objectId, 0,1000);
							_o.currentGroupList = aL;
							if(!bNoDisplay){
								var sT = "dir";
								if(oG.groupType == "BUCKET") sT = "bucket";
								var oPG = AM6Client.get("GROUP", oG.parentId);
								if(oPG && oPG != null) this.addLine("<" + sT + "> ..", oPG);
								for(var i = 0; i < aL.length; i++){
									sT = "dir";
									if(aL[i].groupType == "BUCKET") sT = "bucket";
									this.addLine("<" + sT + "> " + aL[i].name, aL[i]);
								}
							}
							aL = [];
							switch(oG.groupType){
								case "DATA":
									aL = AM6Client.list("DATA", oG.objectId, 0,1000);
									
									var sSubType = oG.name.replace(/s$/gi,"");
									if(this.subType.includes(sSubType)){
										aL = aL.concat(AM6Client.list(sSubType.toUpperCase(), oG.objectId, 0,0));
									}
									
									break;
								case "BUCKET":
									/// Need alternate way to handle other bucket types such as ROLE, ACCOUNT, etc
									///
									aL = AM6Client.members("GROUP", oG.objectId, "DATA");
									break;
							}
							_o.currentDataList = aL;
							if(!bNoDisplay){
								for(var i = 0; i < aL.length; i++){
									this.addLine(this.decorateItem(aL[i]), aL[i]);
								}
							}
						}
					},
					
					subType : [
						"Address","Contact","Application","Group","Ticket","Story","Requirement","Note","Module","Model","Goal","ValidationRule","Form","FormElement","Case","Artifact","ProcessStep","Process","Method","Stage","Data","Work","Task","Cost","Time","Estimate","Budget","Person","Account","Resource","Lifecycle","Project","Schedule","Methodology","Policy","Pattern","Rule","Fact","Operation","Function","Permission","Role","Tag","Event","Location","Trait"
					],
					decorateItem : function(o){
						if(typeof o == "string" || !o.nameType) return o;
						var r = o;
						switch(o.nameType){
							case "DATA":
								r = this.decorateDataItemName(o);
								break;
							case "USER":
							case "PERSON":
								r = this.decorateProfileIcon(o);
								break;
							default:
								r = o.name;
								break;
						};
						return r;
					},
					decorateProfileIcon : function(o){
						var _p = this.getProperties();
						if(!_p.iconView) return o.name;
						var w = (_p.iconWidth ? _p.iconWidth : 48);
						var h = (_p.iconHeight ? _p.iconHeight : 48);
						var oL = document.createElement("div");
						var oP = document.createElement("p");
						oP.setAttribute("style","text-indent:0px !important;");
						var oP2 = document.createElement("p");
						var oI = document.createElement("img");
						oI.setAttribute("class","alignright");
						var sIco = "/AccountManagerService/Media/Icons/user_48x48.png";
						var sPid = AM6Client.getAttributeValue(o,"v1-profile",0);
						
						oP.appendChild(oI);
						oP.appendChild(document.createTextNode(o.name));
						oP.appendChild(document.createElement("br"));
						oP.appendChild(document.createTextNode((o.description ? o.description : "")));
						oP.appendChild(document.createElement("br"));
						oP.appendChild(document.createTextNode((o.alias ? o.alias : "")));
						oL.appendChild(oP);
						oP2.setAttribute("class","clearalign");
						oL.appendChild(oP2);
						if(sPid){
							AM6Client.get("DATA", sPid, function(s, v){
								if(v && v.json) v = v.json;
								if(v && v != null){;
									var sOrg = AM6Client.dotPath(v.organizationPath);
									oI.setAttribute("src","/AccountManagerService/thumbnail/" + sOrg + "/Data" + v.groupPath + "/" + v.name + "/" + w + "x" + h);
								}
								else{
									oI.setAttribute("src",sIco);
								}
							});
						}
						else{
							oI.setAttribute("src",sIco);
						}
						return oL;
					},
					decorateDataItemName : function(o){
						var _p = this.getProperties();
						if(!_p.iconView) return o.name;
						var w = (_p.iconWidth ? _p.iconWidth : 48);
						var h = (_p.iconHeight ? _p.iconHeight : 48);
						var oL = document.createElement("div");
						var oP = document.createElement("p");
						oP.setAttribute("style","text-indent:0px !important;");
						var oP2 = document.createElement("p");
						var oI = document.createElement("img");
						oI.setAttribute("class","alignright");
						var sIco = "/AccountManagerService/Media/Icons/Crystal/48x48/48px-Crystal_Clear_action_filenew.png";
						if(o.mimeType.match(/^image/)){
							sIco = "/AccountManagerService/thumbnail/" + AM6Client.dotPath(AM6Client.currentOrganization) + "/Data" + o.groupPath + "/" + o.name + "/" + w + "x" + h
						}
						oI.setAttribute("src",sIco);
						oP.appendChild(oI);
						oP.appendChild(document.createTextNode(o.name));
						oP.appendChild(document.createElement("br"));
						if(o.description != null) oP.appendChild(document.createTextNode(o.description));
						oP.appendChild(document.createElement("br"));
						oP.appendChild(document.createTextNode(o.createdDate.toString()));
						oL.appendChild(oP);
						oP2.setAttribute("class","clearalign");
						oL.appendChild(oP2);
						return oL;
									
					},
					privateCommands : ["login","logout","history","clearHistory"],
					anonymousCommands : ["help","login"],
					peekCommands : ["ls","cd","use"]
						
				});
				
			});
			
			


   		</script>
   		
   		<style type = "text/css">
   		.console-history {
   			font: 10pt Courier #000000;
   			height:400px;

   		}
   		input.console-text {
   			font: 10pt Courier #000000;
   			border-width: 0px;
   			width: 80%;
   		}
   		input.console-text:focus {
   			outline : none;
   		}
   		span.prompt{
   			font: 10pt Courier #000000;
   			margin-right: .2em;
   			
   		}
   		.command {
   			padding-top: 2em;
   		}
   		
   		</style>
    </head>
    <body>
   
      

  <header class="main-header">
    <h1>Account Manager Service</h1>
    <div template = "/AccountManagerService/Forms/UnauthIn.xml"></div>
  </header>
  
  <div id = "contentContainer" class="content">
  	<div class = "uwm-box-border">
	  	<div class = "console-history" component = "wideselect" id = "typelist">
		</div>
		<div id = "commandContainer" class = "command"><span id = "prompt" class = "prompt">Anonymous:$</span><input class = "console-text" type = "text" id = "commandLine" /></div>
	</div>
  </div>

 


    </body>
</html>
